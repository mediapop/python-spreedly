

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyspreedly.api &mdash; pyspreedly 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="pyspreedly 2.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pyspreedly 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyspreedly.api</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">calendar</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">ET</span>
<span class="kn">from</span> <span class="nn">objectify</span> <span class="kn">import</span> <span class="n">objectify_spreedly</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;API_VERSION&#39;</span><span class="p">,</span> <span class="s">&#39;Client&#39;</span><span class="p">,</span> <span class="p">]</span>

<span class="n">API_VERSION</span> <span class="o">=</span> <span class="s">&#39;v4&#39;</span>


<span class="k">def</span> <span class="nf">utc_to_local</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Converts utc datetime to local&#39;&#39;&#39;</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">secs</span><span class="p">)[:</span><span class="mi">6</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">str_to_datetime</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Converts ISO 8601 string (2009-11-10T21:11Z) to LOCAL datetime,</span>
<span class="sd">    or returns None if None is passed&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>  <span class="c">#TODO am I on crack?</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">utc_to_local</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%SZ&#39;</span><span class="p">))</span>

<span class="c">#TODO - more coherent mapping to parse the XML in different methods</span>

<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. py:class:: Client(token, site_name)</span>
<span class="sd">    Create an object to manage queries for a Client on a given site.</span>

<span class="sd">    :param token: API access token for authorization.</span>
<span class="sd">    :param site_name: the site_name registered with spreedly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">site_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_host</span> <span class="o">=</span> <span class="s">&#39;https://spreedly.com&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="s">&#39;/api/{api_version}/{site_name}/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">api_version</span><span class="o">=</span><span class="n">API_VERSION</span><span class="p">,</span> <span class="n">site_name</span><span class="o">=</span><span class="n">site_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_host</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_ft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">ft</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tree</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">None</span>
        <span class="k">return</span> <span class="n">ft</span>

<div class="viewcode-block" id="Client.query"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;get&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: query(url[, data=None, put=&#39;get&#39;])</span>

<span class="sd">        which has the problem that it doesn&#39;t check if there is data for</span>
<span class="sd">        PUT, and is hard to read.</span>

<span class="sd">        status_codes are not checked here, and should be handled by the</span>
<span class="sd">        caller.</span>

<span class="sd">        Delete is only supported on test users</span>

<span class="sd">        :param url: the api url you wish to reach (not incuding site/version)</span>
<span class="sd">        :param data: the data to send in the request. Default to `None`</span>
<span class="sd">        :type data: UTF-8 encoded XML or None</span>
<span class="sd">        :param action: one of &#39;get&#39;, &#39;post&#39;, &#39;put&#39; and &#39;delete&#39;.  Case insensitive, Default &#39;get&#39;</span>
<span class="sd">        :return: response object</span>
<span class="sd">        :rtype: :py:mod:`requests` response object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;put&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">,</span><span class="s">&#39;delete&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s">&#39;python-spreedly 1.1&#39;</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;put&#39;</span><span class="p">,</span><span class="s">&#39;post&#39;</span><span class="p">):</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/xml&#39;</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span><span class="s">&#39;X&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">action</span><span class="p">)(</span><span class="n">url</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="Client.get_plans"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.get_plans">[docs]</a>    <span class="k">def</span> <span class="nf">get_plans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method::get_plans()</span>
<span class="sd">        get subscription plans for the configured site</span>
<span class="sd">        :returns: data as dict</span>
<span class="sd">        :raises: :py:exc:`HTTPError` if response is not 200</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">&#39;subscription_plans.xml&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;get&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c"># Parse</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">objectify_spreedly</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c">## Subscriber manipulation</span></div>
<div class="viewcode-block" id="Client.create_subscriber"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.create_subscriber">[docs]</a>    <span class="k">def</span> <span class="nf">create_subscriber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">screen_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; .. py:method::create_subscriber(customer_id, screen_name)</span>
<span class="sd">        Creates a subscription</span>
<span class="sd">        :param customer_id: Customer ID</span>
<span class="sd">        :param screen_name: Customer&#39;s screen name</span>
<span class="sd">        :returns: Data for created customer</span>
<span class="sd">        :raises: HTTPError if response code isn&#39;t 201</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        &lt;subscriber&gt;</span>
<span class="s">            &lt;customer-id&gt;{id}&lt;/customer-id&gt;</span>
<span class="s">            &lt;screen-name&gt;{name}&lt;/screen-name&gt;</span>
<span class="s">        &lt;/subscriber&gt;</span>
<span class="s">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">screen_name</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">&#39;subscribers.xml&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>

        <span class="c"># Parse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s">&quot;status code: {0}, text: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">objectify_spreedly</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Client.get_signup_url"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.get_signup_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_signup_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="n">plan_id</span><span class="p">,</span> <span class="n">screen_name</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; .. py:method:: get_signup_url(subscriber_id, plan_id, screen_name)</span>
<span class="sd">        Subscribe a user to the site plan on a free trial</span>

<span class="sd">        subscribe a user to a plan, either trial or not</span>
<span class="sd">        :param subscriber_id: ID of the subscriber</span>
<span class="sd">        :param plan_id: subscription plan ID</span>
<span class="sd">        :param screen_name: user screen name</span>
<span class="sd">        :param token: customer token or None - if passed use the token version</span>
<span class="sd">            of the url</span>
<span class="sd">        :returns: url for subscription</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">subscriber_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="n">plan_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">plan_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;subscribers&#39;</span><span class="p">,</span><span class="n">subscriber_id</span><span class="p">,</span><span class="n">token</span><span class="p">,</span>
                <span class="s">&#39;subscribe&#39;</span><span class="p">,</span> <span class="n">plan_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;subscribers&#39;</span><span class="p">,</span><span class="n">subscriber_id</span><span class="p">,</span><span class="s">&#39;subscribe&#39;</span><span class="p">,</span>
                <span class="n">plan_id</span><span class="p">,</span><span class="n">screen_name</span><span class="p">))</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span>
</div>
<div class="viewcode-block" id="Client.subscribe"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="n">plan_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; .. py:method:: subscribe(subscriber_id, plan_id)</span>
<span class="sd">        Subscribe a user to the site plan on a free trial</span>

<span class="sd">        subscribe a user to a free trial plan.</span>
<span class="sd">        :param subscriber_id: ID of the subscriber</span>
<span class="sd">        :parma plan_id: subscription plan ID</span>
<span class="sd">        :returns: dictionary with xml data if all is good</span>
<span class="sd">        :raises: HTTPError if response status not 200</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#TODO - This lacks subscription for a site to a plan_id.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        &lt;subscription_plan&gt;</span>
<span class="s">            &lt;id&gt;{plan_id}&lt;/id&gt;</span>
<span class="s">        &lt;/subscription_plan&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plan_id</span><span class="o">=</span><span class="n">plan_id</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;subscribers/{id}/subscribe_to_free_trial.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s">&quot;status code: {0}, text: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>

        <span class="c"># Parse</span>
        <span class="k">return</span> <span class="n">objectify_spreedly</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Client.get_info"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: get_info(subscriber_id)</span>

<span class="sd">        :param subscriber_id: Id of subscriber to fetch</span>
<span class="sd">        :returns: Data as dictionary</span>
<span class="sd">        :raises: HTTPError if not 200</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;subscribers/{id}.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;get&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c"># Parse</span>
        <span class="k">return</span> <span class="n">objectify_spreedly</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Client.allow_free_trial"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.allow_free_trial">[docs]</a>    <span class="k">def</span> <span class="nf">allow_free_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: allow_free_trial(subscriber_id)</span>

<span class="sd">        programatically allow for a new free trial</span>
<span class="sd">        :param subscriber_id: the id of the subscriber</span>
<span class="sd">        :returns: subscriber data as dictionary if all good,</span>
<span class="sd">        :raises: HTTPError if not so good (non-200)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;subscribers/{id}/allow_free_trial.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s">&#39;status; {0}, text {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">objectify_spreedly</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Client.add_fee"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.add_fee">[docs]</a>    <span class="k">def</span> <span class="nf">add_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: add_fee(subscriber_id, name, description, group, amount)</span>
<span class="sd">        Add a fee to a user with subscriber_id</span>
<span class="sd">        :param subscriber_id: the id of the subscriber</span>
<span class="sd">        :param name: the name of the fee (eg - Excess Bandwidth Charge)</span>
<span class="sd">        :param description: a description of the charge</span>
<span class="sd">        :param group: a group to add this charge too</span>
<span class="sd">        :param amount: the amount the charge is for</span>
<span class="sd">        :returns: the response object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        &lt;fee&gt;</span>
<span class="s">          &lt;name&gt;{name}&lt;/name&gt;</span>
<span class="s">          &lt;description&gt;{description}&lt;/description&gt;</span>
<span class="s">          &lt;group&gt;{group}&lt;/group&gt;</span>
<span class="s">          &lt;amount&gt;{amount}&lt;/amount&gt;</span>
<span class="s">        &lt;/fee&gt;</span>
<span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;subscribers/{id}/fees.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="Client.set_info"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.set_info">[docs]</a>    <span class="k">def</span> <span class="nf">set_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method: set_info(subscriber_id[, **kw])</span>
<span class="sd">        this corrisponds to the update-subscriber action. passed kw args are</span>
<span class="sd">        placed into the xml data (not sure how the -/_ are dealt with though)</span>

<span class="sd">        There is a design flaw atm where sclient.set_info(sclient.get_info(123))</span>
<span class="sd">        will not work at all as the keys are all different</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;subscriber&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;subscribers/{id}.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;put&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Client.create_complimentary_subscription"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.create_complimentary_subscription">[docs]</a>    <span class="k">def</span> <span class="nf">create_complimentary_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span>
            <span class="n">duration</span><span class="p">,</span> <span class="n">duration_units</span><span class="p">,</span> <span class="n">feature_level</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: create_complimentary_subscription(subscriber_id, duration, duration_units, feature_level[, start_time=None, amount=None])</span>

<span class="sd">        corrisponds to adding corrisponding subscription to a subscriber</span>
<span class="sd">        :param subscriber_id: Subscriber ID</span>
<span class="sd">        :param duration: Duration (unitless)</span>
<span class="sd">        :param duration_units: Unit for above (days, weeks, months i think)</span>
<span class="sd">        :param feature_level string: what feature level this is at</span>
<span class="sd">        :param start_time: If assgining a value for pro-rating purpose, you need this start datetime</span>
<span class="sd">        :type start_time: datetime.datetime or None</span>
<span class="sd">        :param amount: How much this comp is worth</span>
<span class="sd">        :type amount: float or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start_time</span> <span class="ow">and</span> <span class="n">amount</span><span class="p">:</span>
            <span class="n">comp_value</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;&lt;start-time&gt;{start_time}&lt;/start_time&gt;</span>
<span class="s">            &lt;amount&gt;{amount}&lt;/amount&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%SZ&#39;</span><span class="p">),</span>
                    <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comp_value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;&lt;complimentary_subscription&gt;</span>
<span class="s">            &lt;duration_quantity&gt;{duration}&lt;/duration_quantity&gt;</span>
<span class="s">            &lt;duration_units&gt;{duration_units}&lt;/duration_units&gt;</span>
<span class="s">            &lt;feature_level&gt;{level}&lt;/feature_level&gt;</span>
<span class="s">            {comp_value}</span>
<span class="s">            &lt;/complimentary_subscription&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">duration_units</span><span class="o">=</span><span class="n">duration_units</span><span class="p">,</span> 
                    <span class="n">level</span><span class="o">=</span><span class="n">feature_level</span><span class="p">,</span><span class="n">comp_value</span><span class="o">=</span><span class="n">comp_value</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;subscribers/{subscriber_id}/complimentary_subscriptions.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscriber_id</span><span class="o">=</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Client.complimentary_time_extensions"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.complimentary_time_extensions">[docs]</a>    <span class="k">def</span> <span class="nf">complimentary_time_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">duration_units</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: complimentary_time_extension(subscriber_id, duration, duration_units)</span>

<span class="sd">        corrisponds to adding complimentary time extension to a subscriber</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;&lt;complimentary_time_extension&gt;</span>
<span class="s">            &lt;duration_quantity&gt;{duration}&lt;/duration_quantity&gt;</span>
<span class="s">            &lt;duration_units&gt;{duration_units}&lt;/duration_units&gt;</span>
<span class="s">            &lt;/complimentary_time_extension&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">duration_units</span><span class="o">=</span><span class="n">duration_units</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span><span class="s">&#39;subscribers/{id}/complimentary_time_extensions.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Client.get_or_create_subscriber"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.get_or_create_subscriber">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_subscriber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="n">screen_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: get_or_create_subscriber(subscriber_id, screen_name)</span>
<span class="sd">        Tries to get info for a subscriber, else creates a new subscriber</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">subscriber_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscriber</span><span class="p">(</span><span class="n">subscriber_id</span><span class="p">,</span> <span class="n">screen_name</span><span class="p">)</span>

    <span class="c">## Payment Gateway Configuration</span>
    <span class="c">#TODO</span>

    <span class="c">## Invoicing</span>
    <span class="c">#TODO</span>

    <span class="c">## Payments</span>
    <span class="c">#TODO</span>

    <span class="c">## Reporting</span>
    <span class="c">#TODO</span>

    <span class="c">## Emails</span>
    <span class="c">#TODO</span>

    <span class="c">## Testing</span></div>
<div class="viewcode-block" id="Client.delete_subscriber"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.delete_subscriber">[docs]</a>    <span class="k">def</span> <span class="nf">delete_subscriber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: delete_subscriber(id)</span>
<span class="sd">        delete a test subscriber</span>
<span class="sd">        :param id: user id</span>
<span class="sd">        :returns: status code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;test&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;subscribers/{id}.xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;delete&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Client.cleanup"><a class="viewcode-back" href="../../api.html#pyspreedly.api.Client.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; .. py:method:: cleanup()</span>
<span class="sd">        Removes ALL subscribers. NEVER USE IN PRODUCTION! (should only Remove</span>
<span class="sd">        test users...)</span>
<span class="sd">        :returns: status code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;test&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">&#39;subscribers.xml&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;delete&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">return</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pyspreedly 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, James Rivett-Carnac.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>